async function E(r,d={}){const i=d.hostModule,c={env:Object.assign(Object.create(globalThis),d.env||{},{abort(e,t,s,a){e=w(e>>>0),t=w(t>>>0),s=s>>>0,a=a>>>0,(()=>{throw Error(`${e} in ${t}:${s}:${a}`)})()}}),hostModule:Object.assign(Object.create(i),{postProgressMessage(e,t,s,a){e=e>>>0,t=t>>>0,s=s>>>0,a=a>>>0,i.postProgressMessage(e,t,s,a)}})},{exports:n}=await WebAssembly.instantiate(r,c),o=n.memory||d.env.memory,y=Object.setPrototypeOf({initialize(){return P(n.initialize()>>>0)},createImageObject(e,t){return n.createImageObject(e,t)>>>0},setImageObjectContent(e,t){t=O(Uint8ClampedArray,5,0,t)||I(),n.setImageObjectContent(e,t)},getImageObjectPtrLen(e){return A(t=>p(t)>>>0,2,n.getImageObjectPtrLen(e)>>>0)},getImageObjectWidthHeight(e){return A(t=>p(t)>>>0,2,n.getImageObjectWidthHeight(e)>>>0)}},n);function w(e){if(!e)return null;const t=e+new Uint32Array(o.buffer)[e-4>>>2]>>>1,s=new Uint16Array(o.buffer);let a=e>>>1,l="";for(;t-a>1024;)l+=String.fromCharCode(...s.subarray(a,a+=1024));return l+String.fromCharCode(...s.subarray(a,t))}function A(e,t,s){if(!s)return null;const a=p(s+4),l=f.getUint32(s+12,!0),g=new Array(l);for(let u=0;u<l;++u)g[u]=e(a+(u<<t>>>0));return g}function O(e,t,s,a){if(a==null)return 0;const l=a.length,g=n.__pin(n.__new(l<<s,1))>>>0,u=n.__new(12,t)>>>0;return S(u+0,g),f.setUint32(u+4,g,!0),f.setUint32(u+8,l<<s,!0),new e(o.buffer,g,l).set(a),n.__unpin(g),u}class m extends Number{}const U=new FinalizationRegistry(C);function P(e){if(!e)return null;const t=new m(v(e));return U.register(t,e),t}const _=new Map;function v(e){if(e){const t=_.get(e);t?_.set(e,t+1):_.set(n.__pin(e),1)}return e}function C(e){if(e){const t=_.get(e);if(t===1)n.__unpin(e),_.delete(e);else if(t)_.set(e,t-1);else throw Error(`invalid refcount '${t}' for reference '${e}'`)}}function I(){throw TypeError("value must not be null")}let f=new DataView(o.buffer);function S(e,t){try{f.setUint32(e,t,!0)}catch{f=new DataView(o.buffer),f.setUint32(e,t,!0)}}function p(e){try{return f.getUint32(e,!0)}catch{return f=new DataView(o.buffer),f.getUint32(e,!0)}}return y}var h=(r=>(r[r.create=0]="create",r[r.delete=1]="delete",r[r.transfer=2]="transfer",r))(h||{}),j=(r=>(r[r.applyAverageFilter=100]="applyAverageFilter",r))(j||{});const b=await E(await WebAssembly.compileStreaming(fetch("../../../build/as/ASModule.release/index.wasm")),{hostModule:{postProgressMessage(r,d,i,c){self.postMessage({type:j.applyAverageFilter,requestId:c,responsePayload:{id:r},progress:{value:d,valueMax:i}})}}});self.addEventListener("message",r=>{const{type:d,requestId:i}=r.data;switch(d){case h.create:{const{width:c,height:n,buffer:o}=r.data.requestPayload,y=b.createImageObject(c,n),w=new Uint8ClampedArray(o);b.setImageObjectContent(y,w),self.postMessage({type:h.create,requestId:i,responsePayload:{id:y,width:c,height:n}});break}case j.applyAverageFilter:{const{id:c,iteration:n}=r.data.requestPayload;b.applyAverageFilter(c,n,i),self.postMessage({type:d,requestId:i,responsePayload:{id:c}});break}case h.transfer:{const{id:c}=r.data.requestPayload,[n,o]=b.getImageObjectWidthHeight(c),[y,w]=b.getImageObjectPtrLen(c),A=new Uint8ClampedArray(b.memory.buffer,y,w),O=Uint8ClampedArray.from(A);b.deleteImageObject(c),self.postMessage({type:h.transfer,requestId:i,responsePayload:{id:c,width:n,height:o,buffer:O.buffer}},[O.buffer]);break}default:throw new Error("unknown message:"+JSON.stringify(r.data))}});

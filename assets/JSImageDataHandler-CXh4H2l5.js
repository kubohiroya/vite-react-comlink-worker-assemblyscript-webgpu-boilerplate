/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const T=Symbol("Comlink.proxy"),N=Symbol("Comlink.endpoint"),F=Symbol("Comlink.releaseProxy"),P=Symbol("Comlink.finalizer"),M=Symbol("Comlink.thrown"),R=t=>typeof t=="object"&&t!==null||typeof t=="function",L={canHandle:t=>R(t)&&t[T],serialize(t){const{port1:e,port2:r}=new MessageChannel;return C(t,e),[r,[r]]},deserialize(t){return t.start(),B(t)}},U={canHandle:t=>R(t)&&M in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},j=new Map([["proxy",L],["throw",U]]);function V(t,e){for(const r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function C(t,e=globalThis,r=["*"]){e.addEventListener("message",function s(o){if(!o||!o.data)return;if(!V(r,o.origin)){console.warn(`Invalid origin '${o.origin}' for comlink proxy`);return}const{id:a,type:f,path:h}=Object.assign({path:[]},o.data),u=(o.data.argumentList||[]).map(p);let n;try{const i=h.slice(0,-1).reduce((c,g)=>c[g],t),l=h.reduce((c,g)=>c[g],t);switch(f){case"GET":n=l;break;case"SET":i[h.slice(-1)[0]]=p(o.data.value),n=!0;break;case"APPLY":n=l.apply(i,u);break;case"CONSTRUCT":{const c=new l(...u);n=X(c)}break;case"ENDPOINT":{const{port1:c,port2:g}=new MessageChannel;C(t,g),n=q(c,[c])}break;case"RELEASE":n=void 0;break;default:return}}catch(i){n={value:i,[M]:0}}Promise.resolve(n).catch(i=>({value:i,[M]:0})).then(i=>{const[l,c]=I(i);e.postMessage(Object.assign(Object.assign({},l),{id:a}),c),f==="RELEASE"&&(e.removeEventListener("message",s),_(e),P in t&&typeof t[P]=="function"&&t[P]())}).catch(i=>{const[l,c]=I({value:new TypeError("Unserializable return value"),[M]:0});e.postMessage(Object.assign(Object.assign({},l),{id:a}),c)})}),e.start&&e.start()}function W(t){return t.constructor.name==="MessagePort"}function _(t){W(t)&&t.close()}function B(t,e){const r=new Map;return t.addEventListener("message",function(o){const{data:a}=o;if(!a||!a.id)return;const f=r.get(a.id);if(f)try{f(a)}finally{r.delete(a.id)}}),S(t,r,[],e)}function A(t){if(t)throw new Error("Proxy has been released and is not useable")}function v(t){return w(t,new Map,{type:"RELEASE"}).then(()=>{_(t)})}const D=new WeakMap,O="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(D.get(t)||0)-1;D.set(t,e),e===0&&v(t)});function G(t,e){const r=(D.get(e)||0)+1;D.set(e,r),O&&O.register(t,e,t)}function J(t){O&&O.unregister(t)}function S(t,e,r=[],s=function(){}){let o=!1;const a=new Proxy(s,{get(f,h){if(A(o),h===F)return()=>{J(a),v(t),e.clear(),o=!0};if(h==="then"){if(r.length===0)return{then:()=>a};const u=w(t,e,{type:"GET",path:r.map(n=>n.toString())}).then(p);return u.then.bind(u)}return S(t,e,[...r,h])},set(f,h,u){A(o);const[n,i]=I(u);return w(t,e,{type:"SET",path:[...r,h].map(l=>l.toString()),value:n},i).then(p)},apply(f,h,u){A(o);const n=r[r.length-1];if(n===N)return w(t,e,{type:"ENDPOINT"}).then(p);if(n==="bind")return S(t,e,r.slice(0,-1));const[i,l]=k(u);return w(t,e,{type:"APPLY",path:r.map(c=>c.toString()),argumentList:i},l).then(p)},construct(f,h){A(o);const[u,n]=k(h);return w(t,e,{type:"CONSTRUCT",path:r.map(i=>i.toString()),argumentList:u},n).then(p)}});return G(a,t),a}function Y(t){return Array.prototype.concat.apply([],t)}function k(t){const e=t.map(I);return[e.map(r=>r[0]),Y(e.map(r=>r[1]))]}const z=new WeakMap;function q(t,e){return z.set(t,e),t}function X(t){return Object.assign(t,{[T]:!0})}function I(t){for(const[e,r]of j)if(r.canHandle(t)){const[s,o]=r.serialize(t);return[{type:"HANDLER",name:e,value:s},o]}return[{type:"RAW",value:t},z.get(t)||[]]}function p(t){switch(t.type){case"HANDLER":return j.get(t.name).deserialize(t.value);case"RAW":return t.value}}function w(t,e,r,s){return new Promise(o=>{const a=$();e.set(a,o),t.start&&t.start(),t.postMessage(Object.assign({id:a},r),s)})}function $(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class K{width;height;buffer;data;constructor(e,r,s){this.width=e,this.height=r,this.buffer=s,this.data=this.createImageArray(0,e*r*4)}createImageArray(e,r){return new Uint8ClampedArray(this.buffer,e,r)}getData(){return this.data.length==0&&(this.data=this.createImageArray(0,this.width*this.height*4)),this.data}}function Q(t,e,r){const{width:s,height:o}=t;Z(s,o,t.getData(),e,r)}function Z(t,e,r,s,o){const a=Uint8ClampedArray.from(r),f=Uint8ClampedArray.from(r);[...Array(s)].forEach((h,u)=>{o({value:u,valueMax:s}),a.set(f);for(let n=1;n<e-1;n++)for(let i=1;i<t-1;i++){let l=0,c=0,g=0,x=0;for(let d=-1;d<=1;d++)for(let b=-1;b<=1;b++){const y=((n+d)*t+(i+b))*4;l+=a[y+0],c+=a[y+1],g+=a[y+2],x+=a[y+3]}const m=(n*t+i)*4;f[m]=Math.floor(l/9),f[m+1]=Math.floor(c/9),f[m+2]=Math.floor(g/9),f[m+3]=Math.floor(x/9)}}),o({value:s,valueMax:s})}class tt{imageObject;data2;dataArray;currentIndex;constructor(e){this.imageObject=e,this.data2=this.imageObject.createImageArray(0,e.width*e.height*4),this.dataArray=[e.data,this.data2],this.currentIndex=0}setCurrentIndex(e){this.currentIndex=e}getInputData(){return this.dataArray[this.currentIndex%2]}getOutputData(){return this.dataArray[(this.currentIndex+1)%2]}copyData1ToData2(){this.data2.set(this.imageObject.data)}copyData2ToData1(){this.imageObject.data.set(this.data2)}}function et(t,e,r){const{width:s,height:o}=t,a=new tt(t);[...Array(e)].forEach((f,h)=>{a.setCurrentIndex(h),r({value:a.currentIndex,valueMax:e});const u=a.getInputData(),n=a.getOutputData();for(let i=1;i<o-1;i++)for(let l=1;l<s-1;l++){let c=0,g=0,x=0,m=0;for(let b=-1;b<=1;b++)for(let y=-1;y<=1;y++){const E=((i+b)*s+(l+y))*4;c+=u[E+0]&255,g+=u[E+1]&255,x+=u[E+2]&255,m+=u[E+3]&255}const d=(i*s+l)*4;n[d]=Math.floor(c/9)&255,n[d+1]=Math.floor(g/9)&255,n[d+2]=Math.floor(x/9)&255,n[d+3]=Math.floor(m/9)&255}}),e%2===0&&a.copyData2ToData1(),r({value:e,valueMax:e})}class H{imageObject;constructor(){}async initialize(e,r,s){this.imageObject=new K(e,r,s)}async applyAverageFilter(e,r,s){r.doubleBuffering?et(this.imageObject,e,s):Q(this.imageObject,e,s)}async transfer(){return this.imageObject.getData()}close(){self.close()}}C(new H);var rt=Object.freeze({__proto__:null,JSImageDataHandler:H});C(rt);
